{% extends "base.html" %}
{% load static %}
{% block meta %}
<meta property="og:title" content="{{business_name}} Checkout">
<meta property="og:description" content="Welcome to {{business_name}}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:image" content="{% static 'assets/img/logo/black-logo.svg' %}">
{% endblock meta %}
{% block title %}
{{business_name}} - Checkout
{% endblock title %}

{% block content %}
{% include "includes/checkout.html" %}
{% endblock content %}

{% block extra_js %}
<script>
    document.getElementById("shipToDifferent").addEventListener("change", function () {
        const container = document.getElementById("shippingAddressContainer");
        container.style.display = this.checked ? "block" : "none";
    });
</script>

<script>
document.getElementById("place-order-btn").addEventListener("click", function (e) {
    e.preventDefault();

    const csrfToken = getCSRFToken();  // Optional: if CSRF check is enabled
    const formData = new FormData(document.getElementById("order_details_form"));

    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch("{% url 'cart:checkout' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            ...(csrfToken && { "X-CSRFToken": csrfToken })
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert("Order placed successfully!");
            window.location.href = "/shop/";
        } else {
            alert("Error placing order: " + (result.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Request failed:", error);
        alert("Something went wrong.");
    });
});

// Optional helper if CSRF is enabled in your view
function getCSRFToken() {
    const cookie = document.cookie.match(/csrftoken=([\w-]+)/);
    return cookie ? cookie[1] : null;
}
</script>

{% endblock extra_js %}
